{% extends 'base.html' %}

{% block title %}{{ title }} - Aaramba{% endblock %}

{% block content %}
<div class="max-w-lg mx-auto px-4 py-8">
    <div class="bg-white rounded-2xl shadow-md border border-zinc-200 p-6 sm:p-8">

        <h2 class="text-xl sm:text-2xl font-bold text-zinc-900 text-center mb-6">
            {{ title }}
        </h2>

        <form method="post" class="space-y-5">
            {% csrf_token %}

            <button
                type="button"
                onclick="useCurrentLocation()"
                class="h-11 w-full rounded-xl border border-zinc-300 text-sm font-semibold text-zinc-700 hover:bg-zinc-50 transition">
                üìç Use Current Location
            </button>

            {% for field in form %}
                <div>
                    <label for="{{ field.id_for_label }}" class="block text-xs font-semibold text-zinc-700 mb-1">
                        {{ field.label }}
                    </label>
                    <div class="relative">
                        {{ field }}
                    </div>
                    {% if field.errors %}
                        <p class="mt-1 text-xs text-red-600">{{ field.errors|striptags }}</p>
                    {% endif %}
                </div>
            {% endfor %}

            <div class="flex flex-col sm:flex-row gap-3 pt-4">
                <button type="submit"
                        class="h-11 w-full sm:flex-1 rounded-xl bg-black text-white text-sm font-bold
                               hover:bg-zinc-900 transition active:scale-95">
                    Save Address
                </button>

                <a href="{% url 'accounts:address_list' %}"
                   class="h-11 w-full sm:flex-1 rounded-xl border border-zinc-300 bg-white
                          text-sm font-semibold text-zinc-700 flex items-center justify-center
                          hover:bg-zinc-50 transition">
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<script>
async function useCurrentLocation() {
    if (!navigator.geolocation) {
        alert("Geolocation is not supported.");
        return;
    }

    navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        // Fill latitude & longitude fields
        document.getElementById("id_latitude").value = lat;
        document.getElementById("id_longitude").value = lon;

        try {
            const res = await fetch(
                `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&accept-language=en`
            );
            const data = await res.json();
            fillAddress(data.address || {});
        } catch (err) {
            console.error("Could not fetch address.", err);
        }
    }, () => alert("Location permission denied"));
}

function fillAddress(addr) {
    document.getElementById("id_street_address").value = `${addr.road || ""} ${addr.house_number || ""}`.trim();
    document.getElementById("id_road").value = addr.road || "";
    document.getElementById("id_house_number").value = addr.house_number || "";
    document.getElementById("id_village").value = addr.village || "";
    document.getElementById("id_county").value = addr.county || "";
    document.getElementById("id_city").value = addr.city || addr.town || addr.village || "";
    document.getElementById("id_state_district").value = addr.state_district || "";
    document.getElementById("id_state").value = addr.state || "";
    document.getElementById("id_postal_code").value = addr.postcode || "";
    document.getElementById("id_country").value = addr.country || "";
}
</script>
{% endblock %}
