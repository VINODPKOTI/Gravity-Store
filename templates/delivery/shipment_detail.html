{% extends 'base.html' %}
{% block title %}Shipment #{{ shipment.id }} - Aaramba{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-6">
    <div class="max-w-3xl mx-auto">

        <!-- CARD -->
        <div class="bg-white rounded-xl border border-zinc-200 shadow-sm overflow-hidden">

            <!-- HEADER -->
            <div class="px-6 py-4 border-b bg-zinc-50 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold text-zinc-900">
                        Shipment #{{ shipment.id }}
                    </h2>
                    <p class="text-xs text-zinc-500">
                        Order #{{ shipment.order.id }} ‚Ä¢ {{ shipment.seller.business_name }}
                    </p>
                </div>

                <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-medium
                    {% if shipment.status == 'DELIVERED' %}
                        bg-green-50 text-green-700 ring-1 ring-inset ring-green-600/20
                    {% elif shipment.status == 'SHIPPED' %}
                        bg-blue-50 text-blue-700 ring-1 ring-inset ring-blue-600/20
                    {% else %}
                        bg-yellow-50 text-yellow-800 ring-1 ring-inset ring-yellow-600/20
                    {% endif %}
                ">
                    {{ shipment.get_status_display }}
                </span>
            </div>

            <!-- BODY -->
            <div class="p-6 space-y-6">

                <!-- DELIVERY ADDRESS -->
                <div>
                    <h3 class="text-sm font-semibold text-zinc-900 mb-2">
                        Delivery Address
                    </h3>

                    <div class="bg-zinc-50 p-4 rounded-lg border text-sm text-zinc-700 space-y-2">
                        <p>{{ shipment.order.shipping_address }}</p>

                        {% if shipment.order.shipping_address.latitude and shipment.order.shipping_address.longitude %}
                        <div class="pt-2 border-t border-zinc-200">
                            <p class="text-xs text-zinc-500">
                                üìç Coordinates:
                                <span class="font-medium text-zinc-700">
                                    {{ shipment.order.shipping_address.latitude }},
                                    {{ shipment.order.shipping_address.longitude }}
                                </span>
                            </p>

                            <div class="mt-2 flex gap-4 text-xs">
                                <a href="https://www.google.com/maps?q={{ shipment.order.shipping_address.latitude }},{{ shipment.order.shipping_address.longitude }}"
                                   target="_blank"
                                   class="text-blue-600 hover:underline">
                                    Open in Google Maps
                                </a>

                                <a href="https://www.openstreetmap.org/?mlat={{ shipment.order.shipping_address.latitude }}&mlon={{ shipment.order.shipping_address.longitude }}"
                                   target="_blank"
                                   class="text-blue-600 hover:underline">
                                    Open in OpenStreetMap
                                </a>
                            </div>
                        </div>
                        {% else %}
                        <p class="text-xs text-zinc-400 italic">
                            Location coordinates not available
                        </p>
                        {% endif %}
                    </div>

                    {% if shipment.order.shipping_address.latitude and shipment.order.shipping_address.longitude %}
                    <!-- MINI MAP -->
                    <div class="mt-3 rounded-lg overflow-hidden border border-zinc-200">
                        <iframe
                            width="100%"
                            height="220"
                            frameborder="0"
                            scrolling="no"
                            src="https://www.openstreetmap.org/export/embed.html?bbox={{ shipment.order.shipping_address.longitude|add:'-0.01' }},{{ shipment.order.shipping_address.latitude|add:'-0.01' }},{{ shipment.order.shipping_address.longitude|add:'0.01' }},{{ shipment.order.shipping_address.latitude|add:'0.01' }}&layer=mapnik&marker={{ shipment.order.shipping_address.latitude }},{{ shipment.order.shipping_address.longitude }}">
                        </iframe>
                    </div>
                    {% endif %}
                </div>

                <!-- ITEMS -->
                <div>
                    <h3 class="text-sm font-semibold text-zinc-900 mb-2">
                        Items in Package
                    </h3>

                    <ul class="divide-y border rounded-lg overflow-hidden">
                        {% for item in shipment.order.items.all %}
                        {% if item.product.seller == shipment.seller %}
                        <li class="p-3 flex gap-4 items-center">
                            <div class="h-12 w-12 rounded border bg-zinc-100 overflow-hidden">
                                {% if item.product.image %}
                                <img src="{{ item.product.image.url }}" class="h-full w-full object-cover">
                                {% else %}
                                <img src="https://placehold.co/100x100?text=Item" class="h-full w-full object-cover">
                                {% endif %}
                            </div>
                            <div class="text-sm">
                                <p class="font-medium text-zinc-900">
                                    {{ item.product.title }}
                                </p>
                                <p class="text-zinc-500">
                                    Qty: {{ item.quantity }} ‚Ä¢ SKU: {{ item.sku.sku_code }}
                                </p>
                            </div>
                        </li>
                        {% endif %}
                        {% endfor %}
                    </ul>
                </div>

                <!-- ACTIONS -->
                <div class="pt-6 border-t">
                    <h3 class="text-sm font-semibold text-zinc-900 mb-4">
                        Update Status
                    </h3>

                    <form method="post" class="space-y-4">
                        {% csrf_token %}

                        {% if shipment.status == 'READY' %}
                        <button type="submit" name="action" value="mark_shipped"
                            class="w-full rounded-md bg-zinc-900 px-4 py-2 text-sm font-semibold text-white hover:bg-zinc-800">
                            Mark as Shipped
                        </button>

                        {% elif shipment.status == 'SHIPPED' %}
                        <div>
                            <label class="block text-sm font-medium text-zinc-700 mb-1">
                                Proof of Delivery (OTP)
                            </label>
                            <input type="text" placeholder="Enter OTP"
                                class="w-full rounded-md border-zinc-300 text-sm py-2 focus:ring-zinc-900 focus:border-zinc-900">
                        </div>

                        <button type="submit" name="action" value="mark_delivered"
                            class="w-full rounded-md bg-green-600 px-4 py-2 text-sm font-semibold text-white hover:bg-green-500">
                            Mark as Delivered
                        </button>

                        {% else %}
                        <p class="text-center text-sm text-zinc-500 italic">
                            No further actions available.
                        </p>
                        {% endif %}
                    </form>
                </div>
            </div>

            <!-- FOOTER -->
            <div class="bg-zinc-50 px-6 py-4 border-t text-center">
                <a href="{% url 'delivery:dashboard' %}"
                   class="w-full rounded-md bg-zinc-900 px-4 py-2 text-sm font-semibold text-white hover:bg-zinc-800">
                    ‚Üê Back to Dashboard
                </a>
            </div>

        </div>
    </div>
</div>
{% endblock %}
